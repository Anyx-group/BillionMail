# docker-compose.coolify.yml
version: "3.9"

services:
  billionmail:
    # BUILD vanaf source in plaats van pull
    build:
      context: .
      dockerfile: Dockerfiles/Dockerfile
      args:
        - VERSION=latest
    
    container_name: billionmail-core
    hostname: ${BILLIONMAIL_HOSTNAME:-mail.example.com}
    
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      - FAIL2BAN_INIT=${FAIL2BAN_INIT:-y}
      - BILLIONMAIL_HOSTNAME=${BILLIONMAIL_HOSTNAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      
    volumes:
      - billionmail_core:/opt/billionmail/core/data
      - billionmail_vmail:/opt/billionmail/vmail-data
      - ./ssl:/opt/billionmail/ssl:rw
      - ./conf:/opt/billionmail/conf:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
    cap_add:
      - NET_BIND_SERVICE
      - NET_ADMIN
      - NET_RAW
      
    # Mail ports (NIET via Traefik)
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "993:993"
    
    # Coolify Labels voor web interface
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.billionmail.rule=Host(`${BILLIONMAIL_HOSTNAME}`)"
      - "traefik.http.routers.billionmail.entrypoints=https"
      - "traefik.http.routers.billionmail.tls.certresolver=letsencrypt"
      - "traefik.http.services.billionmail.loadbalancer.server.port=80"
      
    restart: unless-stopped
    
    networks:
      - billionmail-net
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

volumes:
  billionmail_core:
    driver: local
  billionmail_vmail:
    driver: local

networks:
  billionmail-net:
    driver: bridge