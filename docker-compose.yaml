# docker-compose.yaml
# BillionMail voor Coolify - Build from Source
version: "3.9"

services:
  billionmail:
    # BUILD vanaf source met correcte Dockerfile
    build:
      context: .
      dockerfile: Dockerfiles/core/Dockerfile  # CRITICAL: Correct pad!
      args:
        - BUILDTIME=${BUILDTIME:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
    
    image: billionmail-core:${VERSION:-latest}
    container_name: billionmail-core
    hostname: ${BILLIONMAIL_HOSTNAME}
    
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      - FAIL2BAN_INIT=${FAIL2BAN_INIT:-y}
      - BILLIONMAIL_HOSTNAME=${BILLIONMAIL_HOSTNAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      
    volumes:
      # Persistent volumes (Coolify managed)
      - core_data:/opt/billionmail/core/data
      - vmail_data:/opt/billionmail/vmail-data
      - ssl_data:/opt/billionmail/ssl
      - conf_data:/opt/billionmail/conf
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
    cap_add:
      - NET_BIND_SERVICE
      - NET_ADMIN
      - NET_RAW
      
    # Mail ports (direct binding, NIET via Traefik)
    ports:
      - "25:25"     # SMTP
      - "465:465"   # SMTPS  
      - "587:587"   # Submission
      - "993:993"   # IMAPS
      
    # Coolify Labels voor Web Interface
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.billionmail-web.rule=Host(`${BILLIONMAIL_HOSTNAME}`)"
      - "traefik.http.routers.billionmail-web.entrypoints=https"
      - "traefik.http.routers.billionmail-web.tls=true"
      - "traefik.http.routers.billionmail-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.billionmail-web.loadbalancer.server.port=80"
      
      # WebMail (RoundCube)
      - "traefik.http.routers.billionmail-webmail.rule=(Host(`${BILLIONMAIL_HOSTNAME}`) && PathPrefix(`/roundcube`)) || Host(`webmail.${DOMAIN}`)"
      - "traefik.http.routers.billionmail-webmail.entrypoints=https"
      - "traefik.http.routers.billionmail-webmail.tls.certresolver=letsencrypt"
      
    restart: unless-stopped
    
    networks:
      - billionmail-net
      
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || curl -f http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s  # Mail servers need tijd om op te starten

volumes:
  core_data:
    driver: local
  vmail_data:
    driver: local
  ssl_data:
    driver: local
  conf_data:
    driver: local

networks:
  billionmail-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-billionmail