# docker-compose.yml
version: "3.9"

services:
  billionmail:
    # Gebruik officiële pre-built image van GitHub Container Registry
    image: ghcr.io/aapanel/billionmail:latest
    
    container_name: billionmail-core
    hostname: ${BILLIONMAIL_HOSTNAME}
    
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      - FAIL2BAN_INIT=${FAIL2BAN_INIT:-y}
      - BILLIONMAIL_HOSTNAME=${BILLIONMAIL_HOSTNAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      
    volumes:
      # Persistent storage (Coolify managed)
      - billionmail_core_data:/opt/billionmail/core/data
      - billionmail_vmail_data:/opt/billionmail/vmail-data
      - billionmail_ssl:/opt/billionmail/ssl
      - billionmail_conf:/opt/billionmail/conf
      - /var/run/docker.sock:/var/run/docker.sock:ro
      
    cap_add:
      - NET_BIND_SERVICE
      - NET_ADMIN
      - NET_RAW
      
    # Mail ports MOETEN geëxposed worden (niet via Traefik)
    ports:
      - "25:25"     # SMTP
      - "465:465"   # SMTPS
      - "587:587"   # Submission
      - "993:993"   # IMAPS
      # Port 80/443 via Coolify/Traefik
      
    labels:
      # Coolify web interface routing
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.billionmail-web.rule=Host(`${BILLIONMAIL_HOSTNAME}`)"
      - "traefik.http.routers.billionmail-web.entrypoints=https"
      - "traefik.http.routers.billionmail-web.tls=true"
      - "traefik.http.routers.billionmail-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.billionmail-web.loadbalancer.server.port=80"
      
      # WebMail routing
      - "traefik.http.routers.billionmail-webmail.rule=Host(`webmail.${DOMAIN}`) || (Host(`${BILLIONMAIL_HOSTNAME}`) && PathPrefix(`/roundcube`))"
      - "traefik.http.routers.billionmail-webmail.entrypoints=https"
      - "traefik.http.routers.billionmail-webmail.tls.certresolver=letsencrypt"
      
    restart: unless-stopped
    
    networks:
      - billionmail-network
      
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  billionmail_core_data:
    driver: local
  billionmail_vmail_data:
    driver: local
  billionmail_ssl:
    driver: local
  billionmail_conf:
    driver: local

networks:
  billionmail-network:
    driver: bridge